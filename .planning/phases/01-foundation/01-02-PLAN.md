---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/i18n/routing.ts
  - src/i18n/navigation.ts
  - src/i18n/request.ts
  - proxy.ts
  - next.config.ts
  - src/app/[locale]/layout.tsx
  - src/app/[locale]/page.tsx
  - src/messages/ro.json
  - src/messages/en.json
  - src/components/layout/LocaleSwitcher.tsx
autonomous: true
requirements:
  - FNDN-02
must_haves:
  truths:
    - "Visiting /ro/ shows Romanian content and visiting /en/ shows English content"
    - "The locale switcher routes between /ro/ and /en/ preserving the current page slug"
    - "`npm run build` output shows static (circle) symbols for all [locale] pages, not dynamic (lambda)"
    - "Visiting / redirects to /ro/ (default locale)"
  artifacts:
    - path: "src/i18n/routing.ts"
      provides: "Locale routing configuration"
      exports: ["routing"]
      contains: "defineRouting"
    - path: "src/i18n/navigation.ts"
      provides: "Type-safe locale navigation utilities"
      exports: ["Link", "redirect", "usePathname", "useRouter"]
      contains: "createNavigation"
    - path: "src/i18n/request.ts"
      provides: "Server-side locale resolution"
      contains: "getRequestConfig"
    - path: "proxy.ts"
      provides: "next-intl middleware for locale routing"
      contains: "createMiddleware"
    - path: "src/app/[locale]/layout.tsx"
      provides: "Locale-aware root layout with setRequestLocale and generateStaticParams"
      contains: "setRequestLocale"
    - path: "src/app/[locale]/page.tsx"
      provides: "Locale-aware homepage with setRequestLocale"
      contains: "setRequestLocale"
    - path: "src/messages/ro.json"
      provides: "Romanian translation strings"
    - path: "src/messages/en.json"
      provides: "English translation strings"
    - path: "src/components/layout/LocaleSwitcher.tsx"
      provides: "Locale switching UI component"
      contains: "useLocale"
  key_links:
    - from: "proxy.ts"
      to: "src/i18n/routing.ts"
      via: "import routing config"
      pattern: "import.*routing"
    - from: "src/app/[locale]/layout.tsx"
      to: "next-intl/server"
      via: "setRequestLocale call"
      pattern: "setRequestLocale"
    - from: "src/app/[locale]/layout.tsx"
      to: "src/i18n/routing.ts"
      via: "generateStaticParams from routing.locales"
      pattern: "routing\\.locales"
    - from: "next.config.ts"
      to: "src/i18n/request.ts"
      via: "createNextIntlPlugin"
      pattern: "createNextIntlPlugin"
---

<objective>
Configure next-intl 4.x with bilingual routing (RO primary, EN secondary) and verify all pages render statically.

Purpose: Bilingual routing is the foundation for all content — every page in Phases 2-8 depends on `[locale]` routing working correctly with static rendering. Getting `lambda` (dynamic) symbols in build output would break the PageSpeed 90+ goal.
Output: Working `[locale]` routing with RO/EN, locale switcher component, translation files, and static build verification.
</objective>

<execution_context>
@/Users/mihaigrigore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mihaigrigore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/1-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up next-intl routing, middleware, and locale layout with static rendering</name>
  <files>
    src/i18n/routing.ts
    src/i18n/navigation.ts
    src/i18n/request.ts
    proxy.ts
    next.config.ts
    src/app/[locale]/layout.tsx
    src/app/[locale]/page.tsx
    src/messages/ro.json
    src/messages/en.json
  </files>
  <action>
1. Install next-intl: `npm install next-intl`

2. Create `src/i18n/routing.ts`:
```typescript
import { defineRouting } from 'next-intl/routing';

export const routing = defineRouting({
  locales: ['ro', 'en'],
  defaultLocale: 'ro',
  localePrefix: 'always',
});
```

3. Create `src/i18n/navigation.ts`:
```typescript
import { createNavigation } from 'next-intl/navigation';
import { routing } from './routing';

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);
```

4. Create `src/i18n/request.ts`:
```typescript
import { getRequestConfig } from 'next-intl/server';
import { hasLocale } from 'next-intl';
import { routing } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  const requested = await requestLocale;
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale;

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
  };
});
```

5. Create `proxy.ts` at the project root (NOT middleware.ts — Next.js 16 uses proxy.ts):
```typescript
import createMiddleware from 'next-intl/middleware';
import { routing } from './src/i18n/routing';

export default createMiddleware(routing);

export const config = {
  matcher: ['/((?!api|trpc|_next|_vercel|.*\\..*).*)'],
};
```

6. Update `next.config.ts` to use the next-intl plugin:
```typescript
import type { NextConfig } from 'next';
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig: NextConfig = {};

export default withNextIntl(nextConfig);
```

7. Move `src/app/layout.tsx` and `src/app/page.tsx` into `src/app/[locale]/`. Delete the originals. The new `src/app/[locale]/layout.tsx` must:
   - Import and call `setRequestLocale(locale)` before any next-intl API usage
   - Call `generateStaticParams()` returning `routing.locales.map(locale => ({ locale }))`
   - Wrap children in `<NextIntlClientProvider>`
   - Use `await params` to get locale (async params — Next.js 16 requirement)
   - Validate locale with `hasLocale()` and call `notFound()` on invalid locale
   - Set `<html lang={locale}>`

8. Create `src/app/[locale]/page.tsx`:
   - Call `setRequestLocale(locale)` as the first statement
   - Use `useTranslations('HomePage')` to render translated content
   - Use `use(params)` or `await params` pattern for locale extraction

9. Create minimal translation files:
   - `src/messages/ro.json`: `{ "HomePage": { "title": "AceAgency", "subtitle": "Agentie digitala premium din Bucuresti" } }`
   - `src/messages/en.json`: `{ "HomePage": { "title": "AceAgency", "subtitle": "Premium digital agency from Bucharest" } }`

10. If a root `src/app/layout.tsx` is still needed (for global styles import only), keep it minimal or move the import into the `[locale]/layout.tsx`. Ensure there is NO duplicate layout wrapping.

11. Run `npm run build` and check the output. Every `[locale]` page MUST show `○` (static), NOT `λ` (dynamic). If any page shows `λ`, the most likely cause is a missing `setRequestLocale()` call — fix before proceeding.
  </action>
  <verify>
- `npm run build` exits with code 0
- Build output shows `○` for all `[locale]` pages (not `λ`)
- `curl -s http://localhost:3000/ | head -5` redirects to `/ro/`
- `grep "setRequestLocale" src/app/\\[locale\\]/layout.tsx` returns a match
- `grep "generateStaticParams" src/app/\\[locale\\]/layout.tsx` returns a match
  </verify>
  <done>next-intl routing configured with RO/EN locales, proxy.ts middleware active, all pages rendering statically (circle in build output), translation files in place.</done>
</task>

<task type="auto">
  <name>Task 2: Build LocaleSwitcher component and verify bidirectional locale navigation</name>
  <files>
    src/components/layout/LocaleSwitcher.tsx
    src/app/[locale]/layout.tsx
  </files>
  <action>
1. Create `src/components/layout/LocaleSwitcher.tsx` as a `"use client"` component:
```typescript
'use client';

import { useLocale } from 'next-intl';
import { useRouter, usePathname } from '@/i18n/navigation';
import { routing } from '@/i18n/routing';

export function LocaleSwitcher(): JSX.Element {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  function handleSwitch(nextLocale: string): void {
    router.replace(pathname, { locale: nextLocale });
  }

  return (
    <nav aria-label="Language switcher" className="flex gap-2">
      {routing.locales.map((loc) => (
        <button
          key={loc}
          onClick={() => handleSwitch(loc)}
          aria-current={locale === loc ? 'true' : undefined}
          className={`min-h-12 min-w-12 rounded px-3 py-2 text-sm font-medium transition-colors ${
            locale === loc
              ? 'bg-primary text-primary-foreground'
              : 'bg-muted text-muted-foreground hover:bg-muted/80'
          }`}
        >
          {loc.toUpperCase()}
        </button>
      ))}
    </nav>
  );
}
```

2. Add the `LocaleSwitcher` to `src/app/[locale]/layout.tsx` in the body, positioned in a header area so it is visible on every page. Keep it simple — just render the component in a top bar for now (Header component comes in Phase 2).

3. Run `npm run build` to verify the client component compiles correctly and pages remain static.

4. Run `npm run dev`, visit `/ro/` and `/en/`, click the locale switcher buttons, and verify:
   - Clicking EN on `/ro/` navigates to `/en/`
   - Clicking RO on `/en/` navigates to `/ro/`
   - The page slug is preserved (e.g., if on `/ro/about` → `/en/about`)
  </action>
  <verify>
- `npm run build` exits with code 0 (pages still static after adding client component)
- `ls src/components/layout/LocaleSwitcher.tsx` exists
- `grep "useLocale" src/components/layout/LocaleSwitcher.tsx` returns a match
- `grep "LocaleSwitcher" src/app/\\[locale\\]/layout.tsx` returns a match (component is rendered in layout)
  </verify>
  <done>LocaleSwitcher component renders RO/EN buttons, switches locale while preserving page slug, uses 48px tap targets, and does not break static rendering.</done>
</task>

</tasks>

<verification>
1. `npm run build` exits with code 0 and all `[locale]` pages show `○` (static)
2. Visiting `/` redirects to `/ro/`
3. `/ro/` shows Romanian content, `/en/` shows English content
4. LocaleSwitcher navigates between `/ro/` and `/en/` preserving page slug
5. `proxy.ts` exists at project root (not middleware.ts)
6. `next.config.ts` uses `createNextIntlPlugin`
</verification>

<success_criteria>
- Bilingual routing works: /ro/ and /en/ serve correct translations
- Static rendering verified: build output shows circle for all locale pages
- LocaleSwitcher component is functional and accessible
- Translation files exist with matching keys in both languages
- No console errors related to locale resolution
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
